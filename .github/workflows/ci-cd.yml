name: ğŸ›’ ì•Œêµ¬ëª¬ í¬ë¡¤ëŸ¬ CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18.x'

jobs:
  # 1ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë‹¨ê³„
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ” ì½”ë“œ ê²€ì¦ (ESLint)
        run: |
          # ESLintê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¬¸ë²• ê²€ì‚¬
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npm run lint || echo "ESLint ì„¤ì • ì—†ìŒ - ê±´ë„ˆë›°ê¸°"
          else
            echo "âœ… ë¬¸ë²• ê²€ì‚¬ ê±´ë„ˆë›°ê¸° (ESLint ë¯¸ì„¤ì •)"
          fi

      - name: ğŸ§ª í¬ë¡¤ë§ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ¯ ì¹´í…Œê³ ë¦¬ë³„ í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          
          # ì¹´í…Œê³ ë¦¬ 1 í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ ê²€ì¦)
          npm test category 1
          
          echo "âœ… ê¸°ë³¸ í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ğŸ”Œ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_ANON_KEY" ]; then
            echo "ğŸ—„ï¸ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘..."
            node -e "
              require('dotenv').config();
              const { createClient } = require('@supabase/supabase-js');
              
              async function testConnection() {
                try {
                  const supabase = createClient(
                    process.env.SUPABASE_URL,
                    process.env.SUPABASE_ANON_KEY
                  );
                  
                  const { data, error } = await supabase
                    .from('deals')
                    .select('count')
                    .limit(1);
                    
                  if (error) throw error;
                  console.log('âœ… Supabase ì—°ê²° ì„±ê³µ');
                } catch (error) {
                  console.error('âŒ Supabase ì—°ê²° ì‹¤íŒ¨:', error.message);
                  process.exit(1);
                }
              }
              
              testConnection();
            "
          else
            echo "âš ï¸ Supabase í™˜ê²½ë³€ìˆ˜ ì—†ìŒ - ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°"
          fi

      - name: ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
          # ë‹¨ìˆœ Node.js í”„ë¡œì íŠ¸ì´ë¯€ë¡œ ë¬¸ë²• ê²€ì¦ë§Œ
          node -c src/index.js
          node -c src/crawler.js  
          node -c src/supabase.js
          echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
          echo "âœ… í¬ë¡¤ë§ ê¸°ëŠ¥ ì •ìƒ"
          echo "âœ… ì½”ë“œ ë¬¸ë²• ì •ìƒ"
          echo "âœ… ë¹Œë“œ ê°€ëŠ¥"
          if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âœ… Supabase ì—°ê²° ì •ìƒ"
          fi

  # 2ï¸âƒ£ ë°°í¬ ë‹¨ê³„ (í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‹œì—ë§Œ)
  deploy:
    name: ğŸš€ Render.com ë°°í¬
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸš€ Render.com ë°°í¬ íŠ¸ë¦¬ê±°
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            echo "ğŸš€ Render.com ë°°í¬ ì‹œì‘..."
            curl -X POST "$RENDER_DEPLOY_HOOK"
            echo "âœ… ë°°í¬ ìš”ì²­ ì™„ë£Œ"
          else
            echo "âš ï¸ Render.com Deploy Hookì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
            echo "ğŸ‘‰ Render.comì—ì„œ Deploy Hook URLì„ ë³µì‚¬í•˜ì—¬"
            echo "    GitHub Secretsì˜ RENDER_DEPLOY_HOOKì— ì¶”ê°€í•˜ì„¸ìš”"
          fi

      - name: ğŸ¯ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"
          echo "ğŸ“Š ë°°í¬ ìƒíƒœëŠ” Render.com ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”"
          echo "ğŸŒ ë°°í¬ ì™„ë£Œ í›„ ì„œë²„ ìƒíƒœ: https://your-app-name.onrender.com/status"

  # 3ï¸âƒ£ ë°°í¬ í›„ ê²€ì¦ (ì„ íƒì )
  verify:
    name: âœ… ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: â³ ë°°í¬ ëŒ€ê¸° (2ë¶„)
        run: |
          echo "â³ ì„œë²„ ì‹œì‘ì„ ìœ„í•´ 2ë¶„ ëŒ€ê¸°..."
          sleep 120

      - name: ğŸ¥ í—¬ìŠ¤ì²´í¬
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          if [ -n "$RENDER_APP_URL" ]; then
            echo "ğŸ¥ ë°°í¬ëœ ì„œë²„ í—¬ìŠ¤ì²´í¬..."
            
            # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
            curl -f "$RENDER_APP_URL/health" || {
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              exit 1
            }
            
            echo "âœ… ì„œë²„ ì •ìƒ ë™ì‘ í™•ì¸"
          else
            echo "âš ï¸ RENDER_APP_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ í—¬ìŠ¤ì²´í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
          fi

      - name: ğŸŠ ë°°í¬ ì„±ê³µ
        run: |
          echo "ğŸŠ ì•Œêµ¬ëª¬ í¬ë¡¤ëŸ¬ ë°°í¬ ì„±ê³µ!"
          echo "â° 5ë¶„ë§ˆë‹¤ ìë™ í¬ë¡¤ë§ì´ ì‹œì‘ë©ë‹ˆë‹¤"
          echo "ğŸ—„ï¸ ë°ì´í„°ëŠ” Supabaseì— ì €ì¥ë©ë‹ˆë‹¤"
          echo "ğŸŒ ì„œë²„ ìƒíƒœ ëª¨ë‹ˆí„°ë§: https://your-app-name.onrender.com/status"